Чтобы запустить gp_legacy_string_agg в Greenplum, которая позволит использовать функцию string_agg нужно запустить следующее

```
CREATE EXTENSION gp_legacy_string_agg;
```

пример использования
```sql
#region Динамическая генерация условия condition_event_type_u которое позволит далее создать событие u        -- Получаем список столбцов из конкретной таблицы, исключая столбцы с ключами, если необходимо        
SELECT  
            string_agg(  
                    'nr.' || column_name || ' IS DISTINCT FROM ' || 't.' || column_name, ' OR ')  
        INTO  
            condition_event_type_u  
        FROM  
            information_schema.columns  
        WHERE  
              table_schema = 'erp'  
          AND table_name = 'transfer_report_19'  
              -- здесь необходимо исключить автогенерируемы столбцы и столбцы относящиеся к ключу  
          AND column_name NOT IN  
              ('event_guid', 'event_type', 'schema_version', 'task_dtm', 'task_guid', 'task_row_count', 'created_ts',  
               'md5_key', 'date_customer_invoice', 'finance_year',  
               'registrar_number', 'number_rtu', 'sf_number', 'code', 'sku_guid', 'l6_sku_guid', 'sales_order_guid',  
               'creator_guid');

-- region Помечаем строки u  
    EXECUTE format('WITH  
    rows AS (SELECT                 t.md5_key             FROM                 erp_cur.transfer_report_19 AS t                     INNER JOIN new_rows AS nr ON t.md5_key = nr.md5_key             WHERE                 %s    )UPDATE new_rows  
SET  
    event_type = ''u''  
FROM  
    rowsWHERE  
      new_rows.md5_key = rows.md5_key  AND new_rows.event_type IS NULL', condition_event_type_u);
```

пример поиска строчек по всем столбцам в которых есть null

```sql
  
BEGIN TRANSACTION;  
  
ROLLBACK TRANSACTION;  
  
DO $$  
  
    DECLARE  
        condition_colums_temp_table   text;  
        condition_is_null   text;  
        condition_order_by   text;  
    BEGIN  
  
        SELECT            string_agg(  
                    column_name, ', ')  
        INTO  
            condition_colums_temp_table  
        FROM  
            information_schema.columns  
        WHERE  
              table_schema = 'opt_export'  
          AND table_name = 'erp_report_19';  
  
        SELECT  
            string_agg(  
                    column_name || ' IS NULL ', ' OR ')  
        INTO  
            condition_is_null  
        FROM  
            information_schema.columns  
        WHERE  
              table_schema = 'opt_export'  
          AND table_name = 'erp_report_19';  
  
        SELECT  
            string_agg(  
                    column_name, ', ')  
        INTO  
            condition_order_by  
        FROM  
            information_schema.columns  
        WHERE  
              table_schema = 'opt_export'  
          AND table_name = 'erp_report_19';  
  
        DROP TABLE IF EXISTS temp_table;  
  
        EXECUTE format('CREATE TEMP TABLE temp_table AS  
        (SELECT             %s         FROM             opt_export.erp_report_19                 WHERE %s ORDER BY %s)', condition_colums_temp_table, condition_is_null, condition_order_by);  
  
    END $$;  
  
SELECT * FROM temp_table;
```

генерация запроса который добавит определенный столбец ко всем таблицам
```sql
SELECT  
    string_agg(  
            'alter table ' || table_schema || '.' || table_name, ' add task_guid uuid; ')  
FROM  
    information_schema.tables  
WHERE  
      table_schema = 'erp'  
  AND table_name NOT LIKE 'transfer_%';
```
генерация запроса который вернет максимальную длинну по каждому столбцу в таблице/схеме
```sql
SELECT  
    concat(string_agg(  
                   'SELECT ''' || column_name || ''' as table_name, max(length("' || column_name ||  
                   '" )) AS max_length FROM ' ||  
                   table_schema || '.' || table_name, ' UNION ALL '), ';')  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'illinois_export'  
  AND table_name = 'erp_distributors_branches'  
  AND data_type NOT IN ('bigint');
```
возвращает все столбцы определенной таблицы/представления, из которых потом можно собрать запрос
```sql
SELECT  
    string_agg(  
            '"' || column_name || '",')  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'chicago_cur'  
  AND table_name = 'ref_networks';
```

возвращает все столбцы определенной таблицы/представления в текстовом формате, из которых потом можно собрать запрос
```sql
SELECT  
    string_agg(  
            'text("' || column_name || '") as "' || column_name || '",')  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'chicago_cur'  
  AND table_name = 'ref_networks';
```
генерим вставку мэпинга названий столбцов в в настроечную таблицу
```sql
-- region названия столбцов представления  
SELECT  
    concat('INSERT INTO  
    nifi.dwh_bi_sync_columns (                                       base_code                                     , base_version_id                                     , source_name                                     , target_name)VALUES',  
           string_agg('(''' || 'erp.transfer_report_19' || ''', 0, ''' || column_name || ''', ''' || column_name || ''')', ','))  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'bi_export'  
  AND table_name = 'erp_rep_19';  
-- endregion
```
генерим описание типов  данных на экспорт и формируем рекомендацию по выбору типов данных для MSSQL
```sql
-- region описание типов данных на экспорт и рекомендации по таблице-буферу  
SELECT  
    column_name  
  , data_type  
  , numeric_precision  
  , numeric_scale  
  , is_nullable  
  , CASE  
        WHEN data_type = 'uuid'  
            THEN 'uniqueidentifier'  
        WHEN data_type = 'text'  
            THEN 'varchar(max)'  
        WHEN data_type = 'bigint'  
            THEN 'bigint'  
        WHEN data_type = 'numeric'  
            THEN 'decimal(18, 6)'  
        WHEN data_type = 'timestamp without time zone'  
            THEN 'datetime'  
    END AS "рекомендуемые_типы_данных_для_MSSQL"  
  -- , *  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'bi_export'  
  AND table_name = 'erp_rep_19'  
ORDER BY  
    ordinal_position;  
-- endregion
```
собрать запрос для актуального представления справочника из 1с
```sql
SELECT  
    string_agg(  
            ' a.' || column_name, ',')  
FROM  
    information_schema.columns  
WHERE  
      table_schema = 'erp'  
  AND table_name = 'ref_currency';
```
список столбцов временной таблицы в PostgreSQL/Greenplum
```sql
SELECT  
    string_agg(  
            a.attname, ', '  
            ORDER BY a.attnum)  
INTO  
    data_fresh_columns  
FROM  
    pg_attribute a  
        INNER JOIN pg_class c ON a.attrelid = c.oid  
WHERE  
      c.relname = 'data_fresh' -- Название временной таблицы  
  AND c.relnamespace = pg_my_temp_schema() -- Схема текущей временной таблицы  
  AND a.attnum > 0 -- Исключаем системные столбцы  
  AND NOT a.attisdropped;  
-- endregion  
-- region Получаем список столбцов актуального вида исторической таблицы для вставки события d в временную таблицу  
SELECT  
    concat('  
  ''d''  
  , process_uuid_actual_sync  , process_schema_version_delete  , process_task_dtm_delete  , process_uuid_actual_sync  , process_task_row_count_delete  , ', string_agg(  
            'data_cur.' || column_name, ', '  
            ORDER BY ordinal_position))  
INTO  
    target_cur_columns  
FROM  
    information_schema.columns  
WHERE  
      table_schema = target_cur_schema  
  AND table_name = target_cur_table  
  AND column_name <> ALL (columns_technical);  
```