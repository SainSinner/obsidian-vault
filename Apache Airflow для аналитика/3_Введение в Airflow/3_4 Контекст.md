предыдущая [[3_2 Проектная работа перепишем ETL с применением Airflow]]
следующая [[3_4 Jinja]]


На предыдущих этапах мы выяснили, что в Airflow существуют основные компоненты, которые используются для организации рабочего процесса: DAG и операторы (Operator). В этом уроке мы поглубже изучим, из каких "кубиков" состоит оператор, что такое контекст и как передавать данные между задачами. Давайте начнем с понятия контекста.

В Airflow, контекст (context) - это информация, доступная во время выполнения оператора (Operator). Этот контекст предоставляет доступ к различным метаданным и переменным, которые могут быть полезными при выполнении `Task`

Контекст содержит следующие типы информации:

1. **Execution Date (Дата выполнения):** Дата и время отработки дага, не время запуска, а как бы "ожидаемое время"
2. **Task Instance (Экземпляр задачи):** Объект который формируется из `Operator` иначе экземпляр задачи
3. **Parameters (Параметры):** Любые дополнительные параметры, переданные в задачу при её определении
4. **Templates (Шаблоны):** Переменные или значения, подставляемые в коде задачи во время выполнения

Контекст играет важную роль в Airflow, так как он позволяет задачам получать дополнительную мета информацию и использовать её при исполнении, что может быть полезным для динамического создания запросов и многого другого. Далее на практике мы с этим подробнее разберемся.

**Практика:**

**Контекст в PythonOperator**

Давайте на примере попробуем получить доступ к этим полям, воспользуемся PythonOperator. 

```python
from airflow import DAG 
from datetime import datetime 
from airflow.operators.python_operator import PythonOperator 

default_args = {
   "owner": "airflow", 
   "start_date": datetime(2018, 10, 1)
}
 
dag = DAG(
   dag_id="dag", 
   default_args=default_args, 
   schedule_interval="@daily"
) 

# Функция использующая контекст 
# **args/**context это словарь в который будет помещен
# Контекст задачи
def _print_exec_date(**context): 
    print("Контекст", context) 
    
print_exec_date = PythonOperator( 
    task_id="print_exec_date", 
    python_callable=_print_exec_date, 
    dag=dag, )
```

При выводе в _Log_ файл мы получим набор полей, описание нашего `Task`

![](https://ucarecdn.com/fe39ba83-4eb8-4ec5-b491-96832dcd23d5/)

К полям контекста можно обращаться как к элементам словаря:

```css
context["execution_date"]
```

Для доступа к контексту мы использовали такой синтаксис `**context` вместо слова _contex_ можно указать любое другое, такое выражение в Python принимает на вход словарь аргументов. 

**Контекст в BashOperator**

У других операторов тоже есть способ получить эти данные, для примера `BashOperator`

```python
from airflow import DAG 
from datetime import datetime 
from airflow.operators.bash_operator import BashOperator 

default_args = {"owner": "airflow", "start_date": datetime(2018, 10, 1)} 
dag = DAG(dag_id="dag", default_args=default_args, schedule_interval="@daily") 

bash_task = BashOperator( 
    task_id="bash_task", 
    bash_command='echo "Context: \'$message\'"', 
    env={'message': '{{ execution_date }}'}, # Используется jinja выражение
    dag=dag )
```

При выводе в _Log_ файл мы получим дату запуска задачи... Обратите внимание на `2018...` год, это ожидаемая дата исполнения задачи.

![](https://ucarecdn.com/45b90d4c-467d-454a-b54e-a24dc2e6ab14/)

В отличии от PythonOperator здесь мы воспользовались так называемым макросом, это выражения которые можно подставлять в `Operator` для того чтобы получать доступ к полям контекста. В данном случае мы подставили в  текст в выражение `{{ execution_date }}` который вернет, дату запуска задачи.

```ini
bash_command='echo "Context: \'$message\'"', 
env={'message': '{{ execution_date }}'}, # Используется jinja выражение
```

В следующем шаге мы разберем данный код, пока что просто запустите даг и убедитесь что у вас будет все как на картинке. 

**Пример в облаке**

Ссылка на DAG: [http://158.160.116.58:8001/tree?dag_id=0_Examples_3.4.1.1](http://158.160.116.58:8001/tree?dag_id=0_Examples_3.4.1.1)

Ссылка на DAG: [http://158.160.116.58:8001/tree?dag_id=0_Examples_3.4.1.2](http://158.160.116.58:8001/tree?dag_id=0_Examples_3.4.1.2)