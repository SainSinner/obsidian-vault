предыдущая [[3_4 XCOM. Как передавать данные между задачами]]
следующая [[3_4 Контекст и идемпотентность]]

Данный шаг поможет вам собрать воедино важные  темы которых мы касались ранее, а именно: [идемпотентность](https://stepik.org/lesson/556651/step/11?unit=550660), [контекст](https://stepik.org/lesson/559052/step/1?unit=553147) и [макросы](https://stepik.org/lesson/559052/step/3?unit=553147) ([[2_2 Идемпотентность]], [[3_4 Контекст]], [[3_4 Jinja]]). Мы еще раз пройдемся по тем темам которые затрагивали. Кратко про каждый из этих пунктов:

**Идемпотентность** в Airflow это означает, что задачи запускаются независимо от текущей даты выполнения. Например, если задача должна была быть выполнена в прошлый вторник, она будет запущена как будто сегодня прошлый вторник, независимо от фактической даты запуска.

**Контекст** (context) - это данные, доступные при выполнении оператора (Operator). Например: Время и дата запуска задачи.

**Макросы** это специальные команды, вида `{{ ds }}` предоставляемые системой, для упрощения выполнения задач. Они предоставляют доступ к данным и метаданным. Примеры использования макросов: автоматическое включение дат, времени или идентификаторов задач в коде, создание гибких рабочих процессов. 

**Как происходит запуск задач**

Нам дана вот такая задача:

```python
from airflow import DAG
from datetime import timedelta
from datetime import datetime
from airflow.operators.python_operator import PythonOperator

dag = DAG(
  'dag',
  schedule_interval='@daily',
  start_date=datetime(2023,8,27),
  end_date=datetime(2023,9,1)
)


def func(date, **kwargs):
  print(date)

t1 = PythonOperator(
    task_id='t1',
    python_callable=func,
    op_kwargs={
        'date': '{{ ds }}' })
```

У нас есть дата начала, дата конца и интервал между запуском задачи в 1 день. Сегодняшнее число мы возьмем `2023-08-30` Что произойдет когда мы с вами постараемся запустить данную задачу? Под запуском я понимаю не нажатие на кнопку запуска вручную, а состояние когда DAG включен.

![](https://ucarecdn.com/99a87fd9-db26-4380-806a-c9eaf736f0ba/)

После того как DAG будет запущен то, произойдет запуск всех задач которые были сформированы заранее, до сегодняшнего числа.

![](https://ucarecdn.com/5b91c78d-3828-41aa-81a4-d46fd9e740ca/)

Будет запущено 3 задачи, по формуле по которой считается дата запуска DAG. ExecutionDate = StartDate + ScheduleIntervalExecutionDate = StartDate + ScheduleInterval

То есть, Airflow сформирует, по формуле, список дат по которым будет происходить запуск, в нашем случае это будет следующий диапазон:

[ `2023-08-28 + 1 day` , `2023-08-28 + 1 day + 1 day ...` ] = [`2023-08-28`, `2023-08-29`,  `2023-08-30`, `2023-09-01`]

После чего Airflow будет сравнивать текущую дату с теми которые есть в списке, и если текущая больше чем та которая есть в списке, то будет запущена новая задача. **Напомню что** Сегодняшнее число мы возьмем `2023-08-30`!

![](https://ucarecdn.com/daac5955-1864-4d8c-99be-86be282e2d62/)

**Контекст задачи**

Если мы с вами посмотри на центральную задачу, то выясним что запущенная задача будет за `2023-08-28` число. Очевидно что последняя запущенная задача будет за `2023-08-29` (для этого нажмите на квадратик по центру, и в открывающем меню выберите меню `Log`)

![](https://ucarecdn.com/84ad4086-fc03-4dcb-ace8-384d803496ca/)

Произошло следующее, с помощью даты начала исполнения и интервала мы сформировали список дат когда должен был бы произойти запуск, после чего был сформирован список, Airflow взял все даты которые `<` текущей, и запустил их, передав в них такой контекст, который должен был бы быть если бы они запускались "вовремя".