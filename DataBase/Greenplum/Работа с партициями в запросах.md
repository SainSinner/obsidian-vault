Для того чтобы выбрать определенную строку по каждой партиции (например, строку с максимальным значением в определённом столбце), не прибегая к агрегирующим функциям вроде MAX, можно использовать оконные функции (window functions), такие как ROW_NUMBER() или RANK(). Оконные функции позволяют работать с подмножествами данных (партициями) и назначать порядковые номера строкам в каждой из этих партиций.

Пример запроса, который возвращает строку с максимальным значением по каждой партиции, используя оконную функцию ROW_NUMBER():

sql

SELECT *
FROM (
    SELECT 
        your_table.*, 
        ROW_NUMBER() OVER (PARTITION BY partition_column ORDER BY target_column DESC) AS rn
    FROM your_table
) AS ranked
WHERE rn = 1;

Описание:

    ROW_NUMBER() OVER (PARTITION BY partition_column ORDER BY target_column DESC): Мы используем функцию ROW_NUMBER(), которая нумерует строки в каждой партиции (PARTITION BY partition_column) в порядке убывания по целевому столбцу (ORDER BY target_column DESC).
    Вложенный запрос: После того, как строки пронумерованы, во внешнем запросе мы выбираем только те строки, у которых порядковый номер равен 1 (WHERE rn = 1). Это будет строка с максимальным значением в каждом разделе.

Пример:

Допустим, у нас есть таблица sales, где мы хотим выбрать строку с наибольшей суммой продаж (sale_amount) для каждого продавца (seller_id):

sql

SELECT *
FROM (
    SELECT 
        sales.*, 
        ROW_NUMBER() OVER (PARTITION BY seller_id ORDER BY sale_amount DESC) AS rn
    FROM sales
) AS ranked
WHERE rn = 1;

Этот запрос вернёт одну строку для каждого продавца с максимальным значением в столбце sale_amount.
Альтернативы:

Можно также использовать функцию RANK(), если есть вероятность, что несколько строк могут иметь одинаковые максимальные значения. Тогда запрос вернёт все строки с одинаковым максимальным значением:

sql

SELECT *
FROM (
    SELECT 
        your_table.*, 
        RANK() OVER (PARTITION BY partition_column ORDER BY target_column DESC) AS rnk
    FROM your_table
) AS ranked
WHERE rnk = 1;

RANK() присвоит одинаковый ранг строкам с одинаковым значением в целевом столбце.