**Как дать доступ на уровне строк определенному пользователю в Greenplum?**

1. **Row Level Security** - это возможность задавать политику доступа на уровне пользователя.  
    В документации **vmware** утверждается, что данная функция добавлена в Greenplum начиная с 7.0 версии [Release 7.0.0](https://docs.vmware.com/en/VMware-Greenplum/7/greenplum-database/relnotes-release-notes.html#release-7.0.0) описание из документации о том как настраивать [https://docs.vmware.com/en/VMware-Greenplum/7/greenplum-database/admin_guide-row_security.html](https://docs.vmware.com/en/VMware-Greenplum/7/greenplum-database/admin_guide-row_security.html "admin_guide-row_security")  
    На сайте **ArenaData** утверждается, что данная функция добавлена в Greenplum начиная с 7 версии [row-level-security](https://docs.arenadata.io/ru/blog/current/ADB/greenplum-new-3.html#row-level-security)  
    Для поддержки **Row Level Security** необходимо перейти на 7 версию Greenplum, что маловероятно сейчас.
2. **Через функцию SECURITY DEFINER**. Создание таблицы в которой будет представлено соответствие `user_login` и `division`.  
    Затем через join формировать представление с использованием переменной пользователя текущего сеанса `CURRENT_USER`.  
    Ниже запрос-пример  
    
    ```
    SELECT DISTINCT
        division
    FROM
        opt.transfer_prearray
    WHERE
        CASE WHEN CURRENT_USER = 'sgrekhov' THEN division = 'Урал' END;
    ```

###### Разница в вызове функции
```
-- возвращает таблицу
SELECT * FROM bi_cur.opt_report_territory_transfer_prearray();
-- возвращает результат работы функции
SELECT bi_cur.opt_report_territory_transfer_prearray();
```
###### CURRENT_USER и SESSION_USER это разные значения при вызове функции под SECURITY DEFINER
[2024-12-04 14:42:12] 0 rows retrieved in 152 ms (execution: 135 ms, fetching: 17 ms)  
main.public> SELECT bi_cur.opt_report_territory_transfer_prearray()  
CURRENT_USER: esbservice  
SESSION_USER: sgrekhov

### Как Реализовано

Создана таблица в которой содержится информации о соответствии дивизионов пользователю `security.bi_report_territory`

```sql
CREATE TABLE security.bi_report_territory
(
    event_id   serial
        UNIQUE,
    created_ts timestamp DEFAULT timezone('MSK'::text, now()),
    name       text,
    login      text,
    division   text,
    is_deleted boolean   DEFAULT FALSE
) DISTRIBUTED BY (event_id);

alter TABLE security.bi_report_territory owner to esbservice;

COMMENT ON TABLE security.bi_report_territory IS 'Создана для управления доступом к строкам таблицы opt.transfer_prearray через представление bi_cur.opt_report_territory_transfer_prearray. Содержит в себе информацию о соответствии логина пользователя и дивизиона доступного для этого пользователя';
```

Создана функция которая возвращает определенные столбцы и строки согласно соответствию территорий из security.bi_report_territory `bi_cur.opt_report_territory_transfer_prearray()`

```sql
DROP FUNCTION IF EXISTS bi_cur.opt_report_territory_transfer_prearray();  
  
CREATE FUNCTION bi_cur.opt_report_territory_transfer_prearray()  
    RETURNS  
        -- region table  
        table  
        (  
            source                            text,  
            type                              text,  
            year                              bigint,  
            trade_channel_pl                  text,  
            trade_channel                     text,  
            sub_trade_channel                 text,  
            type_of_shipment                  text,  
            old_channel                       text,  
            division                          text,  
            country                           text,  
            network                           text,  
            sku                               text,  
            l6_sap                            text,  
            volume_per_sku                    numeric,  
            brand                             text,  
            type_of_production                text,  
            adj                               text,  
            type_brand                        text,  
            sku_business_category             text,  
            tpc                               text,  
            trade_house                       text,  
            business                          text,  
            portfolio                         text,  
            sku_category                      text,  
            type_of_position                  text,  
            segment                           text,  
            month_date                        date,  
            month                             text,  
            quarter                           text,  
            volume_kg                         numeric,  
            volume                            numeric,  
            base_gross_sales                  numeric,  
            general_price_reduction           numeric,  
            price_increase_agreement_discpunt numeric,  
            gross_sales                       numeric,  
            edlp                              numeric,  
            partnership_discount              numeric,  
            guaranteed_yield                  numeric,  
            retro_fix                         numeric,  
            rebate                            numeric,  
            tm_discount_conditional           numeric,  
            logistic_discount                 numeric,  
            pick_up_discount                  numeric,  
            short_shelf_life_discount         numeric,  
            prepayment_discount               numeric,  
            partnership_discount_and_rebate   numeric,  
            partnership_discount_tt           numeric,  
            listing_discount                  numeric,  
            merchandising                     numeric,  
            discount_promotions               numeric,  
            motivation_discount_sp_and_sr     numeric,  
            trade_marketing                   numeric,  
            compensation_gtn                  numeric,  
            tax                               numeric,  
            net_sales                         numeric,  
            raw_materials                     numeric,  
            pack_materials                    numeric,  
            total_material_costs              numeric,  
            bought_in_costs                   numeric,  
            variable_production_costs         numeric,  
            other_production_costs            numeric,  
            total_production_costs            numeric,  
            variable_warehouse                text,  
            other_warehouse                   text,  
            warehousing_costs                 numeric,  
            intercompany_logistics_costs      numeric,  
            client_logistics_costs            numeric,  
            fixed_logistics_costs             numeric,  
            fines_penalties                   numeric,  
            logistic_costs                    numeric,  
            supply_chain_indirect             numeric,  
            procurement                       numeric,  
            slob_write_off                    numeric,  
            total_supply_chain_indirect_costs numeric,  
            atl                               numeric,  
            btl                               numeric,  
            promo_pack                        numeric,  
            compensation_bm                   numeric,  
            total_brand_marketing_costs       numeric,  
            gross_profit                      numeric,  
            contribution_0                    numeric,  
            contribution_1                    numeric,  
            commercial_labour_costs           numeric,  
            fixed_commercial_labour_costs     numeric,  
            compensation_clc                  numeric,  
            merch_agency                      numeric,  
            bad_debts                         numeric,  
            other_commercial_costs            numeric,  
            compensation_occ                  numeric,  
            total_commercial_cost             numeric,  
            contribution_2                    numeric,  
            general_fot                       numeric,  
            business_support_center_fot       numeric,  
            finance_fot                       numeric,  
            hr_fot                            numeric,  
            it_fot                            numeric,  
            legal_fot                         numeric,  
            business_security_fot             numeric,  
            other_office_costs_fot            numeric,  
            administrative_cost_fot           numeric,  
            general                           numeric,  
            business_support_center           numeric,  
            finance                           numeric,  
            hr                                numeric,  
            it                                numeric,  
            legal                             numeric,  
            business_security                 numeric,  
            other_office_costs                numeric,  
            administrative_cost               numeric,  
            total_admin_cost                  numeric,  
            ebitda                            numeric,  
            depreciation_tpc                  numeric,  
            depreciation_sc                   numeric,  
            depreciation_cc                   numeric,  
            depreciation_ac                   numeric,  
            depreciation                      numeric,  
            ebit                              numeric,  
            fx_difference                     numeric,  
            interest                          numeric,  
            ebt                               numeric,  
            sku_code                          text,  
            sap_code                          text,  
            brand_code                        text,  
            type_of_position_code             text,  
            division_code                     text,  
            type_of_shipment_code             text,  
            client_code                       text,  
            prearray_version                  text  
        )  
    -- endregion  
    LANGUAGE plpgsql  
    SECURITY DEFINER  
AS  
$$  
BEGIN  
    -- =================================================================================================  
    -- Author:     OVP\sgrekhov    -- CreateDate:  2024-12-04    -- Description: формирует данные доступные определенному пользователю по его территориальному признаку указанному таблице security.bi_report_territory    -- из таблицы opt.transfer_prearray.    --    -- TS: #41023    -- Update:     --#00    -- =================================================================================================    -- Проверяем право пользователя вызвавшего сессию на select к таблице которую будем фильтровать далее
IF has_table_privilege(SESSION_USER::text, 'main.opt.transfer_prearray', 'SELECT') IS TRUE  
    THEN        RETURN QUERY            WITH                -- определяем наиболее актуально сочетаниие rf и года в таблице  
                process_uuid_actual AS (SELECT  
                                            pua.process_uuid  
                                        FROM  
                                            opt.transfer_prearray pua  
                                        WHERE  
                                            pua.type = ANY  
                                            (ARRAY ['RF_02'::text, 'RF_05'::text, 'RF_08'::text, 'RF_11'::text])  
                                        ORDER BY  
                                            pua.created_ts DESC  
                                        LIMIT 1  
                                       )  
              , type_year_actual AS (SELECT DISTINCT  
                                         tya.type  
                                       , tya.year  
                                     FROM  
                                         opt.transfer_prearray AS tya  
                                             INNER JOIN process_uuid_actual AS pua ON pua.process_uuid = tya.process_uuid  
                                     ORDER BY  
                                         tya.year DESC, tya.type DESC  
                                     LIMIT 1  
                                       )  
            SELECT  
                -- region columns  
                t.source  
              , t.type  
              , t.year  
              , t.trade_channel_pl  
              , t.trade_channel  
              , t.sub_trade_channel  
              , t.type_of_shipment  
              , t.old_channel  
              , t.division  
              , t.country  
              , t.network  
              , t.sku  
              , t.l6_sap  
              , t.volume_per_sku  
              , t.brand  
              , t.type_of_production  
              , t.adj  
              , t.type_brand  
              , t.sku_business_category  
              , t.tpc  
              , t.trade_house  
              , t.business  
              , t.portfolio  
              , t.sku_category  
              , t.type_of_position  
              , t.segment  
              , t.month_date  
              , t.month  
              , t.quarter  
              , t.volume_kg  
              , t.volume  
              , t.base_gross_sales  
              , t.general_price_reduction  
              , t.price_increase_agreement_discpunt  
              , t.gross_sales  
              , t.edlp  
              , t.partnership_discount  
              , t.guaranteed_yield  
              , t.retro_fix  
              , t.rebate  
              , t.tm_discount_conditional  
              , t.logistic_discount  
              , t.pick_up_discount  
              , t.short_shelf_life_discount  
              , t.prepayment_discount  
              , t.partnership_discount_and_rebate  
              , t.partnership_discount_tt  
              , t.listing_discount  
              , t.merchandising  
              , t.discount_promotions  
              , t.motivation_discount_sp_and_sr  
              , t.trade_marketing  
              , t.compensation_gtn  
              , t.tax  
              , t.net_sales  
              , t.raw_materials  
              , t.pack_materials  
              , t.total_material_costs  
              , t.bought_in_costs  
              , t.variable_production_costs  
              , t.other_production_costs  
              , t.total_production_costs  
              , t.variable_warehouse  
              , t.other_warehouse  
              , t.warehousing_costs  
              , t.intercompany_logistics_costs  
              , t.client_logistics_costs  
              , t.fixed_logistics_costs  
              , t.fines_penalties  
              , t.logistic_costs  
              , t.supply_chain_indirect  
              , t.procurement  
              , t.slob_write_off  
              , t.total_supply_chain_indirect_costs  
              , t.atl  
              , t.btl  
              , t.promo_pack  
              , t.compensation_bm  
              , t.total_brand_marketing_costs  
              , t.gross_profit  
              , t.contribution_0  
              , t.contribution_1  
              , t.commercial_labour_costs  
              , t.fixed_commercial_labour_costs  
              , t.compensation_clc  
              , t.merch_agency  
              , t.bad_debts  
              , t.other_commercial_costs  
              , t.compensation_occ  
              , t.total_commercial_cost  
              , t.contribution_2  
              , t.general_fot  
              , t.business_support_center_fot  
              , t.finance_fot  
              , t.hr_fot  
              , t.it_fot  
              , t.legal_fot  
              , t.business_security_fot  
              , t.other_office_costs_fot  
              , t.administrative_cost_fot  
              , t.general  
              , t.business_support_center  
              , t.finance  
              , t.hr  
              , t.it  
              , t.legal  
              , t.business_security  
              , t.other_office_costs  
              , t.administrative_cost  
              , t.total_admin_cost  
              , t.ebitda  
              , t.depreciation_tpc  
              , t.depreciation_sc  
              , t.depreciation_cc  
              , t.depreciation_ac  
              , t.depreciation  
              , t.ebit  
              , t.fx_difference  
              , t.interest  
              , t.ebt  
              , t.sku_code  
              , t.sap_code  
              , t.brand_code  
              , t.type_of_position_code  
              , t.division_code  
              , t.type_of_shipment_code  
              , t.client_code  
              , t.prearray_version  
            -- endregion  
            FROM  
                main.opt.transfer_prearray AS t  
                    INNER JOIN type_year_actual AS tya ON tya.type = t.type AND tya.year = t.year;  
    ELSE  
        RETURN QUERY            WITH                -- определяем наиболее актуально сочетаниие rf и года в таблице  
                process_uuid_actual AS (SELECT  
                                            pua.process_uuid  
                                        FROM  
                                            opt.transfer_prearray pua  
                                        WHERE  
                                            pua.type = ANY  
                                            (ARRAY ['RF_02'::text, 'RF_05'::text, 'RF_08'::text, 'RF_11'::text])  
                                        ORDER BY  
                                            pua.created_ts DESC  
                                        LIMIT 1  
                                       )  
              , type_year_actual AS (SELECT DISTINCT  
                                         tya.type  
                                       , tya.year  
                                     FROM  
                                         opt.transfer_prearray AS tya  
                                             INNER JOIN process_uuid_actual AS pua ON pua.process_uuid = tya.process_uuid  
                                     ORDER BY  
                                         tya.year DESC, tya.type DESC  
                                     LIMIT 1  
                                       )  
            SELECT  
                -- region columns  
                t.source  
              , t.type  
              , t.year  
              , t.trade_channel_pl  
              , t.trade_channel  
              , t.sub_trade_channel  
              , t.type_of_shipment  
              , t.old_channel  
              , t.division  
              , t.country  
              , t.network  
              , t.sku  
              , t.l6_sap  
              , t.volume_per_sku  
              , t.brand  
              , t.type_of_production  
              , t.adj  
              , t.type_brand  
              , t.sku_business_category  
              , t.tpc  
              , t.trade_house  
              , t.business  
              , t.portfolio  
              , t.sku_category  
              , t.type_of_position  
              , t.segment  
              , t.month_date  
              , t.month  
              , t.quarter  
              , t.volume_kg  
              , t.volume  
              , t.base_gross_sales  
              , t.general_price_reduction  
              , t.price_increase_agreement_discpunt  
              , t.gross_sales  
              , t.edlp  
              , t.partnership_discount  
              , t.guaranteed_yield  
              , t.retro_fix  
              , t.rebate  
              , t.tm_discount_conditional  
              , t.logistic_discount  
              , t.pick_up_discount  
              , t.short_shelf_life_discount  
              , t.prepayment_discount  
              , t.partnership_discount_and_rebate  
              , t.partnership_discount_tt  
              , t.listing_discount  
              , t.merchandising  
              , t.discount_promotions  
              , t.motivation_discount_sp_and_sr  
              , t.trade_marketing  
              , t.compensation_gtn  
              , t.tax  
              , t.net_sales  
              , t.raw_materials  
              , t.pack_materials  
              , t.total_material_costs  
              , t.bought_in_costs  
              , t.variable_production_costs  
              , t.other_production_costs  
              , t.total_production_costs  
              , t.variable_warehouse  
              , t.other_warehouse  
              , t.warehousing_costs  
              , t.intercompany_logistics_costs  
              , t.client_logistics_costs  
              , t.fixed_logistics_costs  
              , t.fines_penalties  
              , t.logistic_costs  
              , t.supply_chain_indirect  
              , t.procurement  
              , t.slob_write_off  
              , t.total_supply_chain_indirect_costs  
              , t.atl  
              , t.btl  
              , t.promo_pack  
              , t.compensation_bm  
              , t.total_brand_marketing_costs  
              , t.gross_profit  
              , t.contribution_0  
              , t.contribution_1  
              , t.commercial_labour_costs  
              , t.fixed_commercial_labour_costs  
              , t.compensation_clc  
              , t.merch_agency  
              , t.bad_debts  
              , t.other_commercial_costs  
              , t.compensation_occ  
              , t.total_commercial_cost  
              , t.contribution_2  
              , t.general_fot  
              , t.business_support_center_fot  
              , t.finance_fot  
              , t.hr_fot  
              , t.it_fot  
              , t.legal_fot  
              , t.business_security_fot  
              , t.other_office_costs_fot  
              , t.administrative_cost_fot  
              , t.general  
              , t.business_support_center  
              , t.finance  
              , t.hr  
              , t.it  
              , t.legal  
              , t.business_security  
              , t.other_office_costs  
              , t.administrative_cost  
              , t.total_admin_cost  
              , t.ebitda  
              , t.depreciation_tpc  
              , t.depreciation_sc  
              , t.depreciation_cc  
              , t.depreciation_ac  
              , t.depreciation  
              , t.ebit  
              , t.fx_difference  
              , t.interest  
              , t.ebt  
              , t.sku_code  
              , t.sap_code  
              , t.brand_code  
              , t.type_of_position_code  
              , t.division_code  
              , t.type_of_shipment_code  
              , t.client_code  
              , t.prearray_version  
            -- endregion  
            FROM  
                main.opt.transfer_prearray AS t  
                    INNER JOIN type_year_actual AS tya ON tya.type = t.type AND tya.year = t.year  
                    INNER JOIN security.bi_report_territory AS brt  
                               ON t.division = brt.division AND brt.is_deleted = FALSE AND  
                                  brt.login = SESSION_USER::text;  
        END IF;  
    -- RAISE NOTICE 'SESSION_USER: %', SESSION_USER;  
    -- RAISE NOTICE 'CURRENT_USER: %', CURRENT_USER;END;  
$$;  
  
ALTER FUNCTION bi_cur.opt_report_territory_transfer_prearray() OWNER TO esbservice;  
  
COMMENT ON FUNCTION bi_cur.opt_report_territory_transfer_prearray() IS 'К этой функции обращаются пользователи чтобы получить актуальные строки из opt.transfer_prearray доступные им согласно security.bi_report_territory';
```

Создана роль для сотрудников от bi которые будут обращаться к таблице `bi_default_user`

```sql
CREATE ROLE bi_default_user;
GRANT USAGE ON SCHEMA bi_cur TO bi_default_user;
GRANT EXECUTE ON FUNCTION bi_cur.opt_report_territory_transfer_prearray() TO bi_default_user;
```

### Как пользоваться

Пользователю необходимо будет под своим логином вызвать запрос.

```
SELECT * FROM bi_cur.opt_report_territory_transfer_prearray();
```

И ему вернутся строки из `opt.transfer_prearray`  
Согласно соответствию разрешенных ему дивизионов в таблице `security.bi_report_territory`

### Как дать права пользователю

Чтобы разрешить определенному пользователю просмотр строк по определенному дивизиону, необходимо:

1. создать пользователя и присвоить ему необходимую роль  
    
    ```sql
    -- region Создаем роль, даем права и присваиваем роль пользователю
    CREATE USER sgrekhov;
    GRANT ldap_users TO sgrekhov;
    GRANT bi_default_user TO sgrekhov;
    -- endregion
    ```
    
2. заполнить столбцы в security.bi_report_territory division и login соответственно.  
    
    ```sql
    -- region Даем разарешение sgrekhov на дивизион Урал
    INSERT INTO
        security.bi_report_territory (
                                       name
                                     , login
                                     , division
                                     , is_deleted)
    VALUES
        (
          'Грехов Святослав Константинович'
        , 'sgrekhov'
        , 'Урал'
        , FALSE);
    
    -- endregion
    ```